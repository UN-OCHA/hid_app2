<div class="page-header">
  <h1 class="page-header__heading" translate>
    Check-in<span ng-if="!isCurrentUser">: {{user.name}}</span>
  </h1>
</div>

<div class="row">
  <div class="col-md-8">

    <div class="block">

      <h2 class="block-heading" translate>Select lists</h2>

      <ui-select ng-model="selectedLists" on-select="updateSelectedLists($select.selected)" class="ui-select--has-border">
        <ui-select-match placeholder="{{'Select a list' | translate}}"><span translate>Select a list</span></ui-select-match>
        <ui-select-choices ui-disable-choice="isSelected(list)" repeat="list.id as list in lists | filter: $select.search">
          <span ng-bind="list.name"></span>
        </ui-select-choices>
      </ui-select>

      <div class="list-group">
        <div ng-repeat="list in selectedLists" class="list-group__item">
          <icon name="check-big"></icon>
          {{list.name}}
          <div class="list-group__item-actions">
            <button type="button" class="btn-transparent" ng-click="removeList(list)">
              <icon name="cancel" text="Remove"></icon>
            </button>
          </div>
        </div>
      </div>

    </div>

    <div class="block">
      <h2 class="block-heading" translate>Check out automatically?</h2>
      <div class="form-editable-section">
        <label for="departureDate" translate>Set a date to be automatically checked out</label>

        <div class="form-list__item">
          <input type="text" id="departureDate" uib-datepicker-popup="dd/MM/yyyy" popup-placement="auto bottom-right" ng-model="departureDate" is-open="datePicker.opened" datepicker-options="dateOptions" close-text="Close" placeholder="dd/mm/yyyy" />
          <button type="button" class="btn-transparent" ng-click="showDatePicker()">
            <icon name="calendar" text="Select a date"></icon>
          </button>
        </div>
      </div>
    </div>

    <div class="block">
      <h2 class="block-heading">
        <span ng-if="isCurrentUser" translate>Update your information</span>
        <span ng-if="!isCurrentUser" translate>Update information</span>
      </h2>

      <!-- TO DO: can't currently set a primary organisation
      <div class="form-editable-section" ng-class="{'active': editOrganizationForm.$visible}">
        <form editable-form name="editOrganizationForm" class="form">
          <div ng-show="!editOrganizationForm.$visible">
            <h3 translate>Current organization:</h3>
            <p>TO DO</p>
            <button type="button" class="btn-icon form__edit" ng-click="editOrganizationForm.$show()" ng-show="!editOrganizationForm.$visible">
              <icon name="edit" text="Change organization"></icon>
            </button>
          </div>
          <button type="button" class="btn-icon form__edit" ng-click="editOrganizationForm.$cancel()" ng-show="editOrganizationForm.$visible">
            <icon name="cancel" text="Cancel"></icon>
          </button>

          <div ng-show="editOrganizationForm.$visible">

            <fieldset class="form-group" ng-if="user.organizations.length">
              <legend translate>Select a primary organization</legend>
              <p ng-repeat="org in user.organizations">
                <input type="radio" id="org-{{org._id}}" name="orgNumbers" ng-model="primaryOrganization.list.name" ng-value="org.list.name" ng-checked="primaryOrganization._id === org._id" />
                <label class="clickie-label" for="org-{{org._id}}">{{org.list.name}}</label>
              </p>
              <button type="button" class="btn-primary" ng-click="setPrimaryOrganization()" translate>Update</button>
            </fieldset>

            <fieldset>
              <legend><strong translate>Add a new primary organization</strong></legend>

              <div class="form-inline-list">
                <div class="form-inline-list__item">
                  <ui-select name="newOrganization" ng-model="newOrganization.list">
                    <ui-select-match placeholder="{{'Add a new organisation'|translate}}">
                      {{$select.selected.name}}
                    </ui-select-match>
                    <ui-select-choices refresh="getOrganizations($select.search)" repeat="organization in organizations | filter: $select.search track by $index">
                      {{organization.name}}
                    </ui-select-choices>
                  </ui-select>
                </div>
                <div class="form-inline-list__item form-inline-list__item--controls">
                  <button type="button" class="btn-primary" ng-click="addOrganization()">
                    Add
                  </button>
                </div>
              </div>
            </fieldset>

          </div>
        </form>
      </div> -->

      <div class="form-editable-section" ng-class="{'active': editPhoneForm.$visible}">
        <form editable-form name="editPhoneForm" class="form">
          <div ng-show="!editPhoneForm.$visible">
            <h3 translate>Current phone number:</h3>
            <p>
              <span ng-if="user.phone_number">{{user.phone_number}}</span>
              <span ng-if="!user.phone_number" translate><em>No phone number</em></span>
            </p>
            <button type="button" class="btn-icon form__edit" ng-click="editPhoneForm.$show()" ng-show="!editPhoneForm.$visible">
              <icon name="edit" text="Change phone number"></icon>
            </button>
          </div>
          <button type="button" class="btn-icon form__edit" ng-click="editPhoneForm.$cancel()" ng-show="editPhoneForm.$visible">
            <icon name="cancel" text="Cancel"></icon>
          </button>

          <div ng-show="editPhoneForm.$visible">

            <fieldset class="form-group" ng-if="user.phone_numbers.length">
              <legend translate>Select a primary phone number</legend>
              <p ng-repeat="phone in user.phone_numbers">
                <input type="radio" id="phone-{{phone._id}}" name="phoneNumbers" ng-model="primaryPhone.number" ng-value="phone.number" ng-checked="primaryPhone.number === phone.number" />
                <label class="clickie-label" for="phone-{{phone._id}}">{{phone.number}}</label>
              </p>
              <button type="button" class="btn-primary"  ng-click="setPrimaryPhone()" translate>Update</button>
            </fieldset>

            <fieldset>
              <legend><strong translate>Add a new primary phone number</strong></legend>
              <div class="form-inline-list">
                <div class="form-inline-list__item form-inline-list__item--short">
                  <label for="new_phone_number" class="sr-only" translate="">Phone type:</label>
                  <div class="styled-select">
                    <select ng-model="newPhoneNumber.type" ng-options="t.value as t.name for t in phoneNumberTypes" id="new_phone_number">
                      <option value="" disabled selected>Type</option></select>
                    </select>
                  </div>
                </div>
                <div class="form-inline-list__item">
                  <bc-phone-number name="phone_number" label="Phone number" ng-model="newPhoneNumber.number" is-valid="isValidPhoneNumber" ng-class="{'has-error': newPhoneNumber.number && !isValidPhoneNumber, 'has-success': newPhoneNumber.number && isValidPhoneNumber}"></bc-phone-number>
                </div>
                <div class="form-inline-list__item form-inline-list__item--controls">
                  <button type="submit" class="btn-primary" ng-click="addPhone()">
                    Add
                  </button>
                </div>
              </div>

          </fieldset>
          </div>
        </form>
      </div>


      <div class="form-editable-section" ng-class="{'active': editEmailForm.$visible}">
        <form editable-form name="editEmailForm" class="form">
          <div ng-show="!editEmailForm.$visible">
            <h3 translate>Current email address:</h3>
            <p>
              <span ng-if="user.email">{{user.email}}</span>
              <span ng-if="!user.email" translate><em>No email</em></span>
            </p>
            <button type="button" class="btn-icon form__edit" ng-click="editEmailForm.$show()"><icon name="edit" text="Change email"></icon></button>
          </div>
          <button type="button" class="btn-icon form__edit" ng-click="editEmailForm.$cancel()" ng-show="editEmailForm.$visible">
            <icon name="cancel" text="Cancel"></icon>
          </button>

          <div ng-show="editEmailForm.$visible">
            <fieldset class="form-group" ng-if="user.emails.length">
              <legend translate>Select a primary email address</legend>
              <p ng-repeat="email in user.emails">
                <input type="radio" id="email-{{email._id}}" name="emails" ng-model="primaryEmail.email" ng-value="email.email" ng-checked="primaryEmail.email === email.email" ng-disabled="!email.validated" />
                <label class="clickie-label" for="email-{{email._id}}">
                  {{email.email}}
                  <span ng-if="!email.validated">
                    <span translate> - Unverified, </span>
                    <button type="button" class="btn-link" ng-click="resendValidationEmail(email.email)" translate>resend validation email</button>
                  </span>
                </label>
              </p>
              <button type="button" class="btn-primary" ng-click="setPrimaryEmail()" translate>Update</button>
            </fieldset>

            <fieldset>
              <legend translate>Add a new email address</legend>
              <p translate>Email addresses must be verified before they can be set as primary.</p>

              <div class="form-inline-list">

                <div class="form-inline-list__item form-inline-list__item--short">
                  <label for="new_email_type" class="sr-only">Email type</label>
                  <div class="styled-select">
                    <select id="new_email_type" ng-model="newEmail.type" ng-options="t.value as t.name for t in emailTypes" class="form-control">
                      <option value="" disabled selected>Type</option>
                    </select>
                  </div>
                </div>
                <div class="form-inline-list__item">
                  <label for="new_email" class="sr-only">Email address</label>
                  <input type="email" id="new_email" ng-model="newEmail.email" class="form-control" placeholder="{{'Email address' | translate}}" />
                </div>

                <div class="form-inline-list__item form-inline-list__item--controls">
                  <button type="submit" class="btn-primary" ng-click="addEmail()">
                    Add
                  </button>
                </div>
              </div>

            </fieldset>

          </div>
        </form>
      </div>

      <div class="form-editable-section" ng-class="{'active': editLocationForm.$visible}">
        <form editable-form name="editLocationForm" class="form">
          <div ng-show="!editLocationForm.$visible">
            <h3 translate>Current location:</h3>
            <p>
              <span ng-if="user.location.country"><span ng-if="user.location.region">{{user.location.region.name}}, </span>{{user.location.country.name}}</span>
              <span ng-if="!user.location.countr" translate><em>No location</em></span>
            </p>
            <button type="button" class="btn-icon form__edit" ng-click="editLocationForm.$show()"><icon name="edit" text="Change location"></icon></button>
          </div>
          <button type="button" class="btn-icon form__edit" ng-click="editLocationForm.$cancel()" ng-show="editLocationForm.$visible">
            <icon name="cancel" text="Cancel"></icon>
          </button>

          <div ng-show="editLocationForm.$visible">
            <fieldset class="form-group" ng-if="user.locations.length">
              <legend translate>Select current location</legend>
              <p ng-repeat="location in user.locations">
                <input type="radio" id="location-{{location.country.id}}" name="locations" ng-model="primaryLocation.location" ng-value="location" />
                <label class="clickie-label" for="location-{{location.country.id}}"><span ng-if="location.region">{{location.region.name}}, </span>{{location.country.name}}</label>
              </p>
              <button type="button" class="btn-primary" ng-click="updateLocation(primaryLocation)" translate>Update</button>
            </fieldset>


            <fieldset>
              <h3 translate>Add a new current location</h3>

              <div class="form-inline-list">
                <div class="form-inline-list__item">
                  <div editable-ui-select="newLocation.country" data-e-form="editLocationForm" data-e-name="country" name="country" e-on-select="setRegions($item, $model)" data-e-ng-model="newLocation.country">
                    Country: {{country.name}}
                    <editable-ui-select-match placeholder="{{'Country'|translate}}">
                      {{$select.selected.name}}
                    </editable-ui-select-match>
                    <editable-ui-select-choices repeat="country in countries | filter: $select.search track by $index">
                      {{country.name}}
                    </editable-ui-select-choices>
                  </div>
                </div>

                <div class="form-inline-list__item">
                  <div editable-ui-select="newLocation.region" data-e-form="editLocationForm" data-e-name="region" name="region" data-e-ng-model="newLocation.region">
                    Region: {{region.name}}
                    <editable-ui-select-match placeholder="{{'Region'|translate}}">
                      {{$select.selected.name}}
                    </editable-ui-select-match>
                    <editable-ui-select-choices repeat="region in regions | filter: $select.search track by $index">
                      {{region.name}}
                    </editable-ui-select-choices>
                  </div>
                </div>

                <div class="form-inline-list__item form-inline-list__item--controls">
                  <button type="submit" class="btn-primary" ng-click="updateLocation(newLocation)" translate>
                    Add
                  </button>

                </div>

              </fieldset>
            </div>

          </div>

        </div>
      </form>
    </div>

    <div class="col-md-4">

      <div class="secondary-block">
        <h2 class="secondary-block__heading">
          <span ng-if="isCurrentUser" translate>Your check in modifications</span>
          <span ng-if="!isCurrentUser" translate>Check in modifications</span>
        </h2>

        <ul class="secondary-block__list">
          <li class="secondary-block__item" translate ng-if="!modifications.location && !modifications.email && !modifications.phone">No modifications</li>
          <li class="secondary-block__item" ng-if="modifications.location">
            <icon name="arrow-right"></icon>
            {{modifications.location | translate}}
          </li>
          <li class="secondary-block__item" ng-if="modifications.email">
            <icon name="arrow-right"></icon>
            {{modifications.email | translate}}
          </li>
          <li class="secondary-block__item" ng-if="modifications.phone">
            <icon name="arrow-right"></icon>
            {{modifications.phone | translate}}
          </li>
        </ul>
      </div>

      <button type="button" class="btn-primary btn-block" ng-click="checkin()" ng-disabled="!selectedLists.length">
        <span ng-if="isCurrentUser" translate="">Check me in</span>
        <span ng-if="!isCurrentUser" translate="">Check in</span>
        <icon name="arrow-right"></icon>
      </button>
    </div>
  </div>
