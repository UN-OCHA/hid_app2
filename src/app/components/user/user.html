<loader ng-if="!userLoaded"></loader>
<div class="profile-alert" ng-class="{'profile-alert--show': saving.show}">
  <div class="profile-alert__inner profile-alert__inner--{{saving.status}}" >
    <div ng-if="saving.status === 'saving'">
      <?xml version="1.0" encoding="utf-8"?><svg width='28px' height='28px' xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="uil-ring"><rect x="0" y="0" width="100" height="100" fill="none" class="bk"></rect><defs><filter id="uil-ring-shadow" x="-100%" y="-100%" width="300%" height="300%"><feOffset result="offOut" in="SourceGraphic" dx="0" dy="0"></feOffset><feGaussianBlur result="blurOut" in="offOut" stdDeviation="0"></feGaussianBlur><feBlend in="SourceGraphic" in2="blurOut" mode="normal"></feBlend></filter></defs><path d="M10,50c0,0,0,0.5,0.1,1.4c0,0.5,0.1,1,0.2,1.7c0,0.3,0.1,0.7,0.1,1.1c0.1,0.4,0.1,0.8,0.2,1.2c0.2,0.8,0.3,1.8,0.5,2.8 c0.3,1,0.6,2.1,0.9,3.2c0.3,1.1,0.9,2.3,1.4,3.5c0.5,1.2,1.2,2.4,1.8,3.7c0.3,0.6,0.8,1.2,1.2,1.9c0.4,0.6,0.8,1.3,1.3,1.9 c1,1.2,1.9,2.6,3.1,3.7c2.2,2.5,5,4.7,7.9,6.7c3,2,6.5,3.4,10.1,4.6c3.6,1.1,7.5,1.5,11.2,1.6c4-0.1,7.7-0.6,11.3-1.6 c3.6-1.2,7-2.6,10-4.6c3-2,5.8-4.2,7.9-6.7c1.2-1.2,2.1-2.5,3.1-3.7c0.5-0.6,0.9-1.3,1.3-1.9c0.4-0.6,0.8-1.3,1.2-1.9 c0.6-1.3,1.3-2.5,1.8-3.7c0.5-1.2,1-2.4,1.4-3.5c0.3-1.1,0.6-2.2,0.9-3.2c0.2-1,0.4-1.9,0.5-2.8c0.1-0.4,0.1-0.8,0.2-1.2 c0-0.4,0.1-0.7,0.1-1.1c0.1-0.7,0.1-1.2,0.2-1.7C90,50.5,90,50,90,50s0,0.5,0,1.4c0,0.5,0,1,0,1.7c0,0.3,0,0.7,0,1.1 c0,0.4-0.1,0.8-0.1,1.2c-0.1,0.9-0.2,1.8-0.4,2.8c-0.2,1-0.5,2.1-0.7,3.3c-0.3,1.2-0.8,2.4-1.2,3.7c-0.2,0.7-0.5,1.3-0.8,1.9 c-0.3,0.7-0.6,1.3-0.9,2c-0.3,0.7-0.7,1.3-1.1,2c-0.4,0.7-0.7,1.4-1.2,2c-1,1.3-1.9,2.7-3.1,4c-2.2,2.7-5,5-8.1,7.1 c-0.8,0.5-1.6,1-2.4,1.5c-0.8,0.5-1.7,0.9-2.6,1.3L66,87.7l-1.4,0.5c-0.9,0.3-1.8,0.7-2.8,1c-3.8,1.1-7.9,1.7-11.8,1.8L47,90.8 c-1,0-2-0.2-3-0.3l-1.5-0.2l-0.7-0.1L41.1,90c-1-0.3-1.9-0.5-2.9-0.7c-0.9-0.3-1.9-0.7-2.8-1L34,87.7l-1.3-0.6 c-0.9-0.4-1.8-0.8-2.6-1.3c-0.8-0.5-1.6-1-2.4-1.5c-3.1-2.1-5.9-4.5-8.1-7.1c-1.2-1.2-2.1-2.7-3.1-4c-0.5-0.6-0.8-1.4-1.2-2 c-0.4-0.7-0.8-1.3-1.1-2c-0.3-0.7-0.6-1.3-0.9-2c-0.3-0.7-0.6-1.3-0.8-1.9c-0.4-1.3-0.9-2.5-1.2-3.7c-0.3-1.2-0.5-2.3-0.7-3.3 c-0.2-1-0.3-2-0.4-2.8c-0.1-0.4-0.1-0.8-0.1-1.2c0-0.4,0-0.7,0-1.1c0-0.7,0-1.2,0-1.7C10,50.5,10,50,10,50z" fill="#007faa" filter="url(#uil-ring-shadow)"><animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" repeatCount="indefinite" dur="1s"></animateTransform></path></svg>
      <span translate>Saving</span>
    </div>
    <div ng-if="saving.status !== 'saving'">
      <icon name="check"></icon>
      {{saving.message}}
    </div>
  </div>
</div>

<div sidebar class="sidebar" ng-class="{'in' : sidebar.open, 'active' : sidebar.sidebars.admin}">
  <div class="sidebar__inner t-user-admin">
    <h2 class="sidebar__heading" translate>User admin</h2>

    <button type="button" class="btn btn-transparent sidebar__close" ng-click="sidebar.close()">
      <icon name="cancel" text="close"></icon>
    </button>

    <div class="sidebar-section">

      <button type="button" ng-click="verifyUser()" class="btn-transparent sidebar-section__button t-verify-btn" ng-if="currentUser.is_admin || currentUser.isManager">
        <icon name="check-circle"></icon>
        <span ng-if="!user.verified" translate>Verify user</span>
        <span ng-if="user.verified" translate>Un-verify user</span>
      </button>

      <a class="btn-transparent sidebar-section__button" href="/checkin/{{user._id}}" ng-if="(currentUser.is_admin || currentUser.isManager || (currentUser._id == user._id)) && isOnline">
        <icon name="check"></icon>
        <span translate>Check into List</span>
      </a>

      <a class="btn-transparent sidebar-section__button" download="{{ user.given_name + ' ' + user.family_name }}.vcf" href="{{ vcardUrl }}">
        <icon name="inbox-download"></icon>
        <span translate>Export Contact Info</span>
      </a>

      <button class="btn-transparent sidebar-section__button" ng-click="sendClaimEmail();" ng-disabled="!isOnline" ng-if="user.is_orphan && (currentUser.is_admin || currentUser.isManager)">
        <icon name="mail-envelope-closed"></icon>
        <span translate>Send Claim Email</span>
      </button>

      <button class="btn-transparent sidebar-section__button" ng-if="currentUser._id !== user._id" ng-disabled="!isOnline" ng-click="notify()">
        <icon name="flag"></icon>
        <span translate>Report a Problem</span>
      </button>

      <button class="btn-danger btn-transparent sidebar-section__button" ng-if="currentUser.is_admin || (currentUser.isManager && !user.email_verified && user.createdBy === currentUser._id)" ng-disabled="!isOnline" ng-click="deleteUser(user)">
        <icon name="trash"></icon>
        <span translate>Delete User</span>
      </button>

    </div>
  </div>
</div>

<div ng-if="!userExists">
  <div class="page-header">
    <h1 class="page-header__heading" translate>User not found</h1>
    <p translate>Sorry, this user was not found. Try searching for Humanitarian Contacts:</p>
  </div>
  <div class="row">
    <div class="col-md-6">
      <div ng-controller="SearchFormCtrl" class="block">
        <form ng-submit="fullSearch(searchUsersTerm)" role="search" class="search-form">
          <div uib-dropdown is-open="showUsersAutocomplete">
            <label for="searchUsers" class="sr-only">{{'Search for a name'|translate}}</label>
            <input type="search" class="input-no-border search-form__input" placeholder="{{'Search for a name'|translate}}" name="searchUsers" id="searchUsers" autocomplete="off" ng-model="searchUsersTerm" ng-model-options="{debounce: 200}" ng-change="searchUsersAutocomplete()">
            <button type="submit" class="btn-transparent search-form__button">
              <icon name="search" text="Search"></icon>
            </button>

            <ul class="dropdown-menu" uib-dropdown-menu>
              <li ng-if="landingUsers.length">
                <ul>
                  <li ng-repeat="result in landingUsers">
                    <a ng-href="users/{{result._id}}" ng-click="saveSearch(result, 'user')">{{result.name}}</a>
                  </li>
                </ul>
              </li>
              <li><button type="button" ng-click="fullSearch(searchUsersTerm)" class="btn-transparent" translate>View all</button></li>
            </ul>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div ng-controller="UserEditCtrl" ng-if="userExists">

  <div class="page-header profile-header" ng-class="{'profile-header--admin' : currentUser.is_admin || user.is_admin}">

    <div class="profile-header__primary" ng-class="{'active' : showProfileForm}">

    <div class="profile-header__image-holder">
      <div class="profile-header__image">
        <icon name="check-circle" text="Verfied" class="profile-header__verified t-verified-tick" ng-show="user.verified"></icon>
        <div class="profile-header__image-inner" style="background-image: url({{pictureUrl}})"></div>
      </div>
        <div ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}" class="profile-header__upload">
          <ng-include src="'app/components/user/upload-button.html'"></ng-include>
        </div>
      </div>

      <div class="profile-header__content">
        <div ng-if="!showProfileForm">
          <h1 class="page-header__heading">
            {{user.given_name}} {{user.family_name}}
          </h1>

          <ul class="profile-header__info"  ng-if="!showProfileForm">
            <li ng-if="user.organization && user.organization.list"><icon name="home"></icon>{{user.organization.acronym || user.organization.name}}</li>
            <li ng-if="user.location"><icon name="map-pin"></icon></i>{{user.location.country.name}}</li>
          </ul>

          <p class="profile-header__status">{{user.status}}</p>
          <p class="profile-header__verified-text" ng-show="user.verified"><icon name="check-circle"></icon>This user has been verified.</p>
          <p class="profile-header__unverified" ng-show="!user.verified"><icon name="cancel-circle"></icon>This user has not been verified. Learn how to verify a profile <a href="https://about.humanitarian.id/faqs/" target="_blank">here</a></p>
        </div>

        <div ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}">
          <label for="given_name" class="sr-only" translate>Given name</label>
          <input type="text" id="given_name" ng-model="user.given_name" ng-blur="updateUser(user.given_name)" />

          <label for="family_name" class="sr-only" translate>Family name</label>
          <input type="text" id="family_name" ng-model="user.family_name" ng-blur="updateUser(user.family_name)" />

          <label for="user_status" class="sr-only" translate>Status</label>
          <textarea id="user_status" ng-model="user.status" ng-blur="updateUser(user.status)"></textarea>
        </div>

        <div ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}" class="profile-header__upload--mobile">
          <ng-include src="'app/components/user/upload-button.html'"></ng-include>
        </div>

        <button type="button" class="btn-primary btn-rounded profile-header__connect-btn profile-header__connect-btn--mobile" ng-class="{'profile-header__connect-btn--with-edit': canEditUser}" ng-show="!showProfileForm" ng-if="connectionInfo.canRequestConnection === true" ng-click="requestConnection()">
          <span translate>Connect</span>
        </button>

      </div>
    </div>

    <div class="page-header__buttons page-header__buttons--profile">

      <button type="button" class="btn-primary btn-rounded profile-header__connect-btn t-connect-btn" ng-class="{'profile-header__connect-btn--with-edit': canEditUser}" ng-if="connectionInfo.canRequestConnection === true" ng-show="!showProfileForm" ng-click="requestConnection()">
        <span translate>Connect</span>
      </button>

      <button type="button" class="btn-icon t-user-edit-btn" ng-click="toggleForm()" ng-show="!showProfileForm" aria-hidden="{{showProfileForm}}" ng-if="canEditUser" ng-disabled="!isOnline">
        <icon name="edit" text="Edit"></icon>
      </button>

      <button type="button" class="btn-icon btn-secondary t-close-edit-btn" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}" ng-click="toggleForm()" ng-if="canEditUser">
        <icon name="check" text="Close"></icon>
      </button>

      <button class="btn-icon btn-toggle-admin t-toggle-admin" type="button" ng-click="sidebar.toggle('admin')" ng-show="!showProfileForm">
        <icon name="wheel" text="Actions"></icon>
      </button>
    </div>

  </div>

  <div ng-if="canViewInfo" class="row">
    <div class="col-xs-12 col-md-6 col-lg-4">
      <h2 class="block-heading" translate>Contact Information</h2>

      <div class="form-section form-section--compact" ng-class="{'form-section--editing' : showProfileForm}">

        <h3 class="form-section__heading" translate>Phone numbers</h3>
        <p class="list__item profile-permission-message" ng-if="connectionInfo.phonesPermission === 'connections'">
          <button type="button" class="btn-link t-request-phone" ng-click="requestConnection()">
            <icon name="eye-hidden"></icon>
            <span translate>Request</span> {{user.given_name}}'s <span translate>phone number</span>
          </button>
          </p>
        <p class="list__item profile-permission-message t-phone-permission-message" ng-if="connectionInfo.phonesPermission === 'pending'">
          <icon name="eye-hidden"></icon>
          <span translate>Your connection request is pending</span>
        </p>
        <p class="list__item profile-permission-message" ng-if="connectionInfo.phonesPermission === 'verified'">
          <icon name="eye-hidden"></icon>
          {{user.given_name}}'s <span translate>phone numbers can only be viewed by verified users.</span>
        </p>

        <ul class="list list--has-primary" ng-if="connectionInfo.phonesPermission === 'view'" ng-show="!showProfileForm" aria-hidden="{{showProfileForm}}">
          <li class="list__item" ng-repeat="phone in user.phone_numbers">
            <icon name="direction-up" text="Primary" class="primary-icon" title="Primary" ng-if="user.phone_number === phone.number"></icon>
            <a ng-href="tel:{{phone.number}}">{{phone.number}}</a>
            <span class="list__meta">{{phone.type}}</span>
          </li>
          <li class="list__item" ng-if="!user.phone_numbers.length"><em translate>No phone numbers</em></li>
        </ul>

        <div ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}">
          <form class="form-section__edit">
            <fieldset>
              <legend class="form-section__sub-heading" translate>Add phone number:</legend>
              <div class="form-field form-field--compact">
                <label for="new_phone_number" class="sr-only" translate>Phone type:</label>
                <div class="styled-select">
                  <select ng-model="temp.phone_number.type" ng-options="t.value as t.name disable when t.value === '' for t in phoneNumberTypes" id="new_phone_number">
                  </select>
                </div>
              </div>
              <div class="form-field form-field--compact form-inline-fields" ng-show="temp.phone_number.type">
                <div class="form-inline-fields__item">
                  <bc-phone-number name="phone_number" label="Phone number" ng-model="temp.phone_number.number" is-valid="isValidPhoneNumber" ng-class="{'has-error': temp.phone_number.number && !isValidPhoneNumber, 'has-success': temp.phone_number.number && isValidPhoneNumber}"></bc-phone-number>
                </div>
                <button type="submit"
                  class="btn-transparent"
                  ng-class="{'active': temp.phone_number.type && temp.phone_number.number && isValidPhoneNumber}"
                  ng-disabled="!temp.phone_number.type || !temp.phone_number.number || !isValidPhoneNumber"
                  ng-click="addItem('phone_number')">
                  <icon name="plus" text="Add"></icon>
                </button>
              </div>
            </fieldset>
          </form>
          <form ng-if="user.phone_numbers.length" class="form-section__edit">
            <fieldset>
              <legend class="form-section__sub-heading" translate>Set primary phone number:</legend>
              <ul class="list list--has-buttons">
                <li class="list__item" ng-repeat="phone in user.phone_numbers">
                  <input type="radio"
                  id="phone-{{phone._id}}"
                  name="phoneNumbers"
                  ng-model="user.phone_number"
                  ng-value="phone.number"
                  ng-change="setPrimaryPhone(phone)"
                  />
                  <label class="clickie-label" for="phone-{{phone._id}}">
                    {{phone.number}}
                    <span class="list__meta">{{phone.type}}</span>
                  </label>

                  <button type="button" class="btn-transparent list__button" ng-click="dropPhoneNumber(phone._id)"><icon name="cancel" text="Remove phone number"></icon></button>
                </li>
              </ul>
            </fieldset>
          </form>

          <form class="form-section__edit">
            <fieldset>
              <legend class="form-section__sub-heading" translate>Who should be able to see your phone numbers?</legend>
              <ul class="list list--has-buttons profile-permissions">
                <li class="list__item" ng-repeat="permission in visibilityOptions">
                  <input type="radio"
                  id="permission-phone-{{$index}}"
                  name="phonesVisibility"
                  ng-model="temp.phonesVisibility"
                  ng-value="permission.value"
                  ng-change="changePermission('phonesVisibility')"
                  />
                  <label class="clickie-label" for="permission-phone-{{$index}}">
                    {{permission.label}}
                  </label>
                </li>
              </ul>
            </fieldset>
          </form>
        </div>

      </div>

      <div class="form-section form-section--compact" ng-class="{'form-section--editing' : showProfileForm}">

        <h3 class="form-section__heading" translate>Email</h3>

        <p class="list__item profile-permission-message" ng-if="connectionInfo.emailsPermission === 'connections'">
          <button type="button" class="btn-link" ng-click="requestConnection()">
          <icon name="eye-hidden"></icon>
          <span translate>Request</span> {{user.given_name}}'s <span translate>email address</span></button>
        </p>
        <p class="list__item profile-permission-message" ng-if="connectionInfo.emailsPermission === 'pending'">
          <icon name="eye-hidden"></icon>
          <span translate>Your connection request is pending</span>
        </p>
        <p class="list__item profile-permission-message" ng-if="connectionInfo.emailsPermission === 'verified'">
          <icon name="eye-hidden"></icon>
          {{user.given_name}}'s <span translate>email addresses can only be viewed by verified users.</span>
        </p>

        <ul class="list list--has-primary" ng-if="connectionInfo.emailsPermission === 'view'" ng-show="!showProfileForm" aria-hidden="{{showProfileForm}}">
          <li class="list__item" ng-repeat="email in user.emails">
            <icon name="direction-up" text="Primary" class="primary-icon" title="Primary" ng-if="user.email === email.email"></icon>
            <a ng-href="mailto:{{email.email}}">{{email.email}}</a>
            <span class="list__meta">{{email.type}} <span ng-if="!email.validated" translate> / Unverified</span></span>
          </li>
          <li class="list__item" ng-if="!user.emails.length"><em translate>No emails</em></li>
        </ul>

        <div ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}">
          <form class="form-section__edit">
            <fieldset>
              <legend class="form-section__sub-heading" translate>Add email:</legend>
              <div class="form-field form-field--compact">
                <label for="new_email_type" class="sr-only" translate>Email type</label>
                <div class="styled-select">
                  <select id="new_email_type" ng-model="temp.email.type" ng-options="t.value as t.name disable when t.value === '' for t in emailTypes">
                  </select>
                </div>
              </div>
              <div class="form-field form-field--compact form-inline-fields" ng-show="temp.email.type">
                <label for="new_email" class="sr-only" translate>Email address</label>
                <input type="email" id="new_email" ng-model="temp.email.email" class="form-inline-fields__item" placeholder="{{'Email address' | translate}}" />
                <button type="submit"
                  class="btn-transparent"
                  ng-class="{'active': temp.email.type && temp.email.email}"
                  ng-disabled="!temp.email.type || !temp.email.email"
                  ng-click="addItem('email')">
                  <icon name="plus" text="Add"></icon>
                </button>
              </div>
            </fieldset>
          </form>
          <form ng-if="user.emails.length" class="form-section__edit">
            <fieldset>
              <legend class="form-section__sub-heading" translate>Set primary email:</legend>
              <ul class="list list--has-buttons">
                <li class="list__item" ng-repeat="email in user.emails">
                  <input
                  type="radio"
                  id="email-{{email._id}}"
                  name="emails"
                  ng-model="user.email"
                  ng-value="email.email"
                  ng-disabled="!email.validated"
                  ng-change="setPrimaryEmail(email.email)" />
                  <label class="clickie-label" for="email-{{email._id}}">
                    {{email.email}}
                    <span class="list__meta">{{email.type}}
                      <span ng-if="!email.validated">
                      <span translate> / Unverified</span> -
                        <button type="button" class="btn-link" ng-click="resendValidationEmail(email.email)" translate>resend validation email</button>
                      </span>
                    </span>
                  </label>
                  <button type="button" class="btn-transparent list__button" ng-click="dropItem('email', email)" ng-if="email.email != user.email"><icon name="cancel" text="Remove"></icon></button>
                </li>
              </ul>
            </fieldset>
          </form>

          <form class="form-section__edit">
            <fieldset>
              <legend class="form-section__sub-heading" translate>Who should be able to see your email addresses?</legend>
              <ul class="list list--has-buttons profile-permissions">
                <li class="list__item" ng-repeat="permission in visibilityOptions">
                  <input type="radio"
                  id="permission-email-{{$index}}"
                  name="emailsVisibility"
                  ng-model="temp.emailsVisibility"
                  ng-value="permission.value"
                  ng-change="changePermission('emailsVisibility')"
                  />
                  <label class="clickie-label" for="permission-email-{{$index}}">
                    {{permission.label}}
                  </label>
                </li>
              </ul>
            </fieldset>
          </form>
        </div>

      </div>

      <div class="form-section form-section--compact" ng-class="{'form-section--editing' : showProfileForm}">
        <h3 class="form-section__heading" translate>Social Networks</h3>

        <form ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}" class="form-section__edit">
          <fieldset>
            <legend class="form-section__sub-heading" translate>Add social network:</legend>
            <div class="form-field form-field--compact">
              <label for="new_voip_type" class="sr-only">Type</label>
              <div class="styled-select">
                <select id="new_voip_type" ng-model="temp.voip.type" ng-options="t.value as t.name disable when t.value === '' for t in voipTypes">
                </select>
              </div>
            </div>
            <div class="form-field form-field--compact form-inline-fields" ng-show="temp.voip.type">
              <label for="new_voip_username" class="sr-only">Username</label>
              <input type="text" class="form-inline-fields__item" name="username" id="new_voip_username" ng-model="temp.voip.username" placeholder="{{'Username' | translate}}" />
              <button type="submit"
                class="btn-transparent"
                ng-class="{'active': temp.voip.type && temp.voip.username}"
                ng-disabled="!temp.voip.type || !temp.voip.username"
                ng-click="addItem('voip')">
                <icon name="plus" text="Add"></icon>
              </button>
            </div>
          </fieldset>
        </form>

        <ul class="list list--has-buttons" ng-class="{'form-section__edit' : showProfileForm && user.voips.length}">
          <li class="list__item" ng-repeat="voip in user.voips">
            {{voip.type}}: {{voip.username}}
            <button type="button" class="btn-transparent list__button" ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}" ng-click="dropItem('voip', voip)"><icon name="cancel" text="Remove"></icon></button>
          </li>
          <li class="list__item" ng-if="!user.voips.length && !showProfileForm"><em translate>No social networks</em></li>
        </ul>

      </div>

    </div>

    <div class="col-xs-12 col-md-6 col-lg-4">
      <h2 class="block-heading" translate>Humanitarian details</h2>

      <div class="form-section form-section--compact" ng-class="{'form-section--editing' : showProfileForm}">

        <h3 class="form-section__heading" translate>Organizations</h3>
        <ul class="list list--has-primary" ng-show="!showProfileForm" aria-hidden="{{showProfileForm}}">
          <li class="list__item" ng-repeat="org in user.organizations">
            <icon name="direction-up" text="Primary" class="primary-icon" title="Primary" ng-if="user.organization.list === org.list"></icon>
            <a href="/lists/{{org.list}}">{{org.name}}</a>
          </li>
          <li class="list__item" ng-if="!user.organizations.length">
            <em translate>No organizations</em>
          </li>
        </ul>

        <div ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}">

          <form class="form-section__edit">
            <label class="form-section__sub-heading" for="newOrganization" translate>Add an organization:</label>
            <div class="form-field form-field--compact form-inline-fields">
              <div class="form-inline-fields__item">
                <ui-select name="newOrganization" ng-model="temp.organization.list">
                  <ui-select-match placeholder="{{'Select an organisation'|translate}}">
                    {{$select.selected.name}}
                  </ui-select-match>
                  <ui-select-choices refresh="getOrganizations($select.search)" repeat="organization in organizations | filter: $select.search track by $index">
                    {{organization.name}}
                  </ui-select-choices>
                </ui-select>
              </div>
              <button type="submit"
                class="btn-transparent"
                ng-class="{'active': temp.organization.list}"
                ng-disabled="!temp.organization.list"
                ng-click="addItem('organization')">
                <icon name="plus" text="Add"></icon>
              </button>
            </div>
            <p translate>If your organization is not listed, click <a href="https://docs.google.com/a/humanitarianresponse.info/forms/d/e/1FAIpQLSdpkMue4gFydSm1PwhSIQonpWRGG50ouJJdo8NbcvaMv_pcDw/viewform?c=0&w=1" target="_blank">here</a> to request adding it.</p>
          </form>

          <form ng-if="user.organizations.length" class="form-section__edit">
            <fieldset>
              <legend class="form-section__sub-heading" translate>Set primary organization:</legend>
              <ul class="list list--has-buttons">
                <li class="list__item" ng-repeat="org in user.organizations">
                  <input type="radio"
                  id="org-{{org.list}}"
                  name="organizations"
                  ng-model="user.organization.list"
                  ng-value="org.list"
                  ng-change="setPrimaryOrganization(org)" />
                  <label class="clickie-label" for="org-{{org.list}}">{{org.name}}</label>
                  <button type="button" class="btn-transparent list__button" ng-show="org.list !== user.organization.list" ng-click="dropItem('organization', org)"><icon name="cancel" text="Remove organization"></icon></button>
                </li>
              </ul>
            </fieldset>
          </form>

        </div>
      </div>

      <div class="form-section form-section--compact" ng-class="{'form-section--editing' : showProfileForm}">
        <h3 class="form-section__heading" translate>Job titles</h3>
        <ul class="list list--has-primary" ng-show="!showProfileForm" aria-hidden="{{showProfileForm}}">
          <li class="list__item" ng-repeat="title in user.job_titles">
            <icon name="direction-up" title="primary" class="primary-icon" ng-if="title === user.job_title"></icon>
            {{title}}
          </li>
          <li class="list__item" ng-if="!user.job_titles.length">
            <em translate>No job titles</em>
          </li>
        </ul>

        <div ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}">
          <form class="form-section__edit">
            <label class="form-section__sub-heading" for="job_title" translate>Add a job title:</label>
            <div class="form-field form-field--compact form-inline-fields">
              <input type="text" class="form-inline-fields__item" name="job_title" id="job_title" ng-model="temp.job_title" placeholder="{{'Add a job title' | translate}}" />
              <button type="submit"
              class="btn-transparent"
              ng-class="{'active': temp.job_title}"
              ng-disabled="!temp.job_title"
              ng-click="addItem('job_title')">
                <icon name="plus" text="Add job title"></icon>
              </button>
            </div>
          </form>

          <form ng-if="user.job_titles.length" class="form-section__edit">
            <fieldset>
              <legend class="form-section__sub-heading" translate>Set primary job title:</legend>

              <ul class="list list--has-buttons">
                <li class="list__item" ng-repeat="title in user.job_titles">
                  <input
                  type="radio"
                  id="title-{{$index}}"
                  name="titles"
                  ng-model="user.job_title"
                  ng-value="title"
                  ng-change="setPrimaryJobTitle(title)"
                  />
                  <label class="clickie-label" for="title-{{$index}}">
                    {{title}}
                  </label>
                  <button type="button" class="btn-transparent list__button" ng-click="dropItem('job_title', title)" ng-if="title != user.job_title"><icon name="cancel" text="Remove"></icon></button>
                </li>
              </ul>
            </fieldset>
          </form>

        </div>

      </div>

      <div class="form-section form-section--compact" ng-class="{'form-section--editing' : showProfileForm}">
        <h3 class="form-section__heading" translate>Locations</h3>

        <p class="list__item profile-permission-message" ng-if="connectionInfo.locationsPermission === 'connections'">
          <button type="button" class="btn-link" ng-click="requestConnection()">
            <icon name="eye-hidden"></icon>
            <span translate>Request</span> {{user.given_name}}'s <span translate>location</span>
          </button>
        </p>
        <p class="list__item profile-permission-message" ng-if="connectionInfo.locationsPermission === 'pending'">
          <icon name="eye-hidden"></icon>
          <span translate>Your connection request is pending</span>
        </p>
        <p class="list__item profile-permission-message" ng-if="connectionInfo.locationsPermission === 'verified'">
          <icon name="eye-hidden"></icon>
          {{user.given_name}}'s <span translate>locations can only be viewed by verified users.</span>
        </p>

        <ul class="list list--has-primary" ng-if="connectionInfo.locationsPermission === 'view'" ng-show="!showProfileForm" aria-hidden="{{showProfileForm}}">
          <li class="list__item" ng-repeat="location in user.locations">
            <icon name="direction-up" text="Primary" class="primary-icon" title="Primary" ng-if="location.tempId === user.location.tempId"></icon>
            <span ng-if="location.locality">{{location.locality}}, </span><span ng-if="location.region">{{location.region.name}}, </span>{{location.country.name}}
          </li>
          <li class="list__item" ng-if="!user.locations.length">
            <em translate>No locations</em>
          </li>
        </ul>

        <div ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}">
          <form class="form-section__edit">
            <label class="form-section__sub-heading" for="location">Add a location:</label>
            <div class="form-field form-field--compact">
              <ui-select ng-model="temp.location.country" on-select="setRegions($item, $model)">
                <ui-select-match placeholder="{{'Select a country' | translate}}">
                  {{$select.selected.name}}
                </ui-select-match>
                <ui-select-choices repeat="country in countries | filter: $select.search track by $index">
                  {{country.name}}
                </ui-select-choices>
              </ui-select>
            </div>
            <div class="form-field form-field--compact" ng-if="showRegion">
              <ui-select ng-model="temp.location.region">
                <ui-select-match placeholder="{{'Select a region' | translate}}">
                  {{$select.selected.name}}
                </ui-select-match>
                <ui-select-choices repeat="region in regions | filter: $select.search track by $index">
                  {{region.name}}
                </ui-select-choices>
              </ui-select>
            </div>

            <div class="form-field form-field--compact" >
              <label for="locality" class="sr-only" translate>Locality</label>
              <input type="text" placeholder="{{'Type a locality' | translate}}" id="locality" ng-model="temp.location.locality">
            </div>

            <button type="submit"
                class="btn-transparent"
                ng-class="{'active': temp.location.country}"
                ng-disabled="!temp.location.country"
                ng-click="addItem('location')">
                <icon name="plus"></icon>
                <span translate>Add location</span>
              </button>
          </form>

          <form ng-if="user.locations.length" class="form-section__edit">
            <fieldset>
              <legend class="form-section__sub-heading" translate>Set primary location:</legend>
              <ul class="list list--has-buttons">
                <li class="list__item" ng-repeat="location in user.locations">
                  <input
                  type="radio"
                  id="location-{{location.tempId}}"
                  name="locations"
                  ng-model="user.location.tempId"
                  ng-value="location.tempId"
                  ng-change="setPrimaryLocation(location)"
                  />
                  <label class="clickie-label" for="location-{{location.tempId}}">
                    <span ng-if="location.locality">{{location.locality}}, </span><span ng-if="location.region">{{location.region.name}}, </span>{{location.country.name}}
                  </label>
                  <button type="button" class="btn-transparent list__button" ng-click="dropItem('location', location)" ng-if="location.tempId !== user.location.tempId">
                    <icon name="cancel" text="Remove location"></icon>
                  </button>
                </li>
              </ul>
            </fieldset>
          </form>

          <form class="form-section__edit">
            <fieldset>
              <legend class="form-section__sub-heading" translate>Who should be able to see your locations?</legend>
              <ul class="list list--has-buttons profile-permissions">
                <li class="list__item" ng-repeat="permission in visibilityOptions">
                  <input type="radio"
                  id="permission-locations-{{$index}}"
                  name="locationsVisibility"
                  ng-model="temp.locationsVisibility"
                  ng-value="permission.value"
                  ng-change="changePermission('locationsVisibility')"
                  />
                  <label class="clickie-label" for="permission-locations-{{$index}}">
                    {{permission.label}}
                  </label>
                </li>
              </ul>
            </fieldset>
          </form>
        </div>
      </div>

    </div>

    <div class="col-xs-12 col-md-6 col-lg-4">
      <h2 class="block-heading" translate>Additional Information</h2>

      <div class="form-section form-section--compact" ng-class="{'form-section--editing' : showProfileForm}" ng-if="currentUser.is_admin || user.functional_roles.length">
        <h3 class="form-section__heading" translate>Functional roles</h3>

        <form ng-show="showProfileForm && currentUser.is_admin" aria-hidden="{{!showProfileForm}}" class="form-section__edit">
          <label class="form-section__sub-heading" for="roles">Add a role:</label>
          <div class="form field form-field--compact form-inline-fields">
            <div class="form-inline-fields__item">
              <ui-select name="roles" ng-model="temp.functional_role.list">
                <ui-select-match placeholder="{{'Select a role' | translate}}">
                  {{$select.selected.name}}
                </ui-select-match>
                <ui-select-choices repeat="role in roles | filter: $select.search track by $index">
                  {{role.name}}
                </ui-select-choices>
              </ui-select>
            </div>
            <button type="submit"
              class="btn-transparent"
              ng-class="{'active': temp.functional_role.list}"
              ng-disabled="!temp.functional_role.list"
              ng-click="addItem('functional_role')">
              <icon name="plus" text="Add"></icon>
            </button>
          </div>
        </form>

        <ul class="tag-list" aria-hidden="{{showProfileForm}}">
          <li class="tag-list__item" ng-class="{'tag-list__item--has-button' : showProfileForm && (currentUser.is_admin || currentUser.isManager)}" ng-repeat="role in user.functional_roles">
            <a href="lists/{{role.list}}">{{role.name}}</a>
            <button type="button" class="btn-transparent tag-list__button" ng-click="dropItem('functional_role', role)" ng-show="showProfileForm" ng-if="currentUser.is_admin || currentUser.isManager" aria-hidden="{{showProfileForm}}">
             <icon name="cancel" text="Check out"></icon>
            </button>
          </li>
          <li class="list__item" ng-if="!user.functional_roles.length" ng-show="!showProfileForm">
            <em translate>No roles</em>
          </li>
        </ul>
      </div>

      <div class="form-section form-section--compact" ng-show="user.operations && user.operations.length">
        <h3 class="form-section__heading" translate>Operations</h3>
        <ul class="tag-list">
          <li class="tag-list__item" ng-class="{'tag-list__item--has-button' : showProfileForm}" ng-repeat="(key, val) in user.operations">
            <a href="/lists/{{val.list}}">{{val.name}}</a>
            <button type="button" class="btn-transparent tag-list__button" ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}" ng-click="dropItem('operation', val)">
              <icon name="cancel" text="Check out"></icon>
            </button>
          </li>
        </ul>
      </div>

      <div class="form-section form-section--compact" ng-show="user.bundles && user.bundles.length">
        <h3 class="form-section__heading" translate>Clusters / Working Groups</h3>
        <ul class="tag-list">
          <li class="tag-list__item" ng-class="{'tag-list__item--has-button' : showProfileForm}" ng-repeat="(key, val) in user.bundles">
            <a href="/lists/{{val.list}}">{{val.name}}</a>
            <button type="button" class="btn-transparent tag-list__button" ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}" ng-click="dropItem('bundle', val)">
              <icon name="cancel" text="Check out"></icon>
            </button>
          </li>
        </ul>
      </div>

      <div class="form-section form-section--compact" ng-show="user.disasters && user.disasters.length">
        <h3 class="form-section__heading" translate>Disasters</h3>
        <ul class="tag-list">
          <li class="tag-list__item" ng-class="{'tag-list__item--has-button' : showProfileForm}" ng-repeat="(key, val) in user.disasters">
            <a href="/lists/{{val.list}}">{{val.name}}</a>
            <button type="button" class="btn-transparent tag-list__button" ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}" ng-click="dropItem('disaster', val)">
              <icon name="cancel" text="Check out"></icon>
            </button>
          </li>
        </ul>
      </div>

      <div class="form-section form-section--compact" ng-show="user.offices && user.offices.length">
        <h3 class="form-section__heading" translate>Co-ordination Hubs</h3>
        <ul class="tag-list">
          <li class="tag-list__item" ng-class="{'tag-list__item--has-button' : showProfileForm}" ng-repeat="(key, val) in user.offices">
            <a href="/lists/{{val.list}}">{{val.name}}</a>
            <button type="button" class="btn-transparent tag-list__button" ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}" ng-click="dropItem('office', val)">
              <icon name="cancel" text="Check out"></icon>
            </button>
          </li>
        </ul>
      </div>

      <div class="form-section form-section--compact" ng-class="{'form-section--editing' : showProfileForm}">

        <h3 class="form-section__heading" translate>Websites</h3>

        <form ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}" class="form-section__edit">
          <label class="form-section__sub-heading" for="newWebsite" translate="">Add website:</label>
          <div class="form-field form-field--compact form-inline-fields">
            <input type="text" ng-pattern="urlRegEx" class="form-inline-fields__item" ng-model="temp.website.url" id="newWebsite" placeholder="URL" />
            <button type="submit"
              class="btn-transparent"
              ng-class="{'active': temp.website.url}"
              ng-disabled="!temp.website.url"
              ng-click="addItem('website')">
              <icon name="plus" text="Add"></icon>
            </button>
          </div>
        </form>

        <div ng-class="{'form-section__edit' : showProfileForm && user.websites.length}">
          <ul class="list list--has-buttons">
            <li class="list__item" ng-repeat="website in user.websites">
              <a ng-href="{{website.url}}">{{website.url}}</a>
              <button type="button" class="btn-transparent list__button" ng-if="canEditUser" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}" ng-click="dropItem('website', website)">
                <icon name="cancel" text="Remove"></icon>
              </button>
            </li>
            <li class="list__item" ng-if="!user.websites.length" ng-show="!showProfileForm"><em translate>No websites</em></li>
          </ul>
        </div>

      </div>

      <div class="form-section form-section--compact" ng-if="currentUser.is_admin && user.verified_by">
        <h3 class="form-section__heading" translate>Verified by</h3>
        <p><a href="/users/{{user.verified_by.id}}">{{user.verified_by.name}}</a></p>
      </div>

      <div class="form-section form-section--compact" ng-class="{'form-section--editing' : showProfileForm}" ng-if="user.is_admin || currentUser.is_admin">

        <h3 class="form-section__heading" translate>Permissions</h3>

        <p ng-if="user.is_admin && !showProfileForm" translate>Administrator</p>
        <p ng-if="user.isManager && !showProfileForm" translate>Manager</p>
        <p ng-if="!user.is_admin && !user.isManager && !showProfileForm"><em translate>No permissions set</em></p>

        <ul class="list form-section__edit" ng-if="canEditUser && currentUser.is_admin" ng-show="showProfileForm" aria-hidden="{{!showProfileForm}}">
          <li class="list__item">
            <input type="checkbox"
            id="isAdmin"
            ng-model="user.is_admin"
            ng-value="user.is_admin"
            ng-change="updateUser(user.is_admin)" />
            <label for="isAdmin" class="clickie-label" translate>Administrator</label>
          </li>

          <li class="list__item">
            <input type="checkbox"
            id="isManager"
            ng-model="user.isManager"
            ng-value="user.isManager"
            ng-change="updateUser(user.isManager)" />
            <label for="isManager" class="clickie-label" translate>Manager</label>
          </li>
        </ul>
      </div>

      <div class="form-section form-section--compact">
        <ul class="list">
          <li class="list__item"><span translate>Last Updated</span>: <span ng-bind="user.lastModified | date:'longDate'"></span></li>
          <li class="list__item"><span translate>Created</span>: <span ng-bind="user.createdAt | date:'longDate'"></span></li>
        </ul>
      </div>

    </div>

  </div>
</div>
